function getLongDT() { Number.prototype.padLeft = function (e, t) { var n = String(e || 10).length - String(this).length + 1; return n > 0 ? (new Array(n)).join(t || "0") + this : this }; var e = new Date; var t = e.getHours() >= 12 ? "PM" : "AM"; var n = e.getHours() % 12; n = n ? n : 12; dformat = [e.getFullYear(), (e.getMonth() + 1).padLeft(), e.getDate().padLeft()].join("-") + "  " + [n, e.getMinutes().padLeft(), e.getSeconds().padLeft()].join(":") + " " + t; dtNow = dformat; return dtNow } function appInterval() { top.updateId = setInterval(appUpdate, top.syncTime * 1e3); top.pinActive = true } function internetError() { $('<div data-role="popup" id="popInternet" data-theme="a" data-position-to="window" data-transition="pop"><p>MapitPRO ALERT: Internet connectivity is unavailable... trying again!<p></div>').popup(); $("#popInternet").popup("open"); setTimeout(function () { $("#popInternet").popup("close") }, 5e3) } function technicalError() { $('<div data-role="popup" id="popTechnical" data-theme="a" data-position-to="window" data-transition="pop"><p>MapitPRO ALERT: System error... trying again!<p></div>').popup(); $("#popTechnical").popup("open"); setTimeout(function () { $("#popTechnical").popup("close") }, 5e3) } function appLogin() { if (top.pinUser == "" || top.pinPswd == "") { alert("MapitPRO ERROR: Username & password fields are mandatory!") } else { if (navigator.onLine) { getLongDT(); $.ajax({ beforeSend: function () { $.mobile.showPageLoadingMsg() }, complete: function () { $.mobile.hidePageLoadingMsg() }, type: "POST", url: wsURL + "appLogin", cache: false, data: '{"u":"' + top.pinUser + '","p":"' + top.pinPswd + '","d":"' + dtNow + '"}', contentType: "application/json; charset=utf-8", success: function (e) { if (e.d == "e") { alert("MapitPRO ERROR: Username or password is not valid... Try again!") } else { var t = jQuery.parseJSON(e.d); var n = t.NewDataSet.Table; if (n[0].PIN_AUTHORIZED == "true") { $("#inpUsername").textinput("disable"); $("#inpPassword").textinput("disable"); $("#btnLogin").closest(".ui-btn").hide(); $("#btnLogout").closest(".ui-btn").show(); if (n[1].SETTINGS_SYNCTIME != null) { top.syncTime = parseInt(n[1].SETTINGS_SYNCTIME) } appStart() } else { alert("MapitPRO ERROR: Username is not authorized... Contact your system administrator!") } } }, error: function (e) { technicalError() } }) } else { internetError() } } return false } function appStart() { if (navigator.onLine) { getLongDT(); $.ajax({ beforeSend: function () { $.mobile.showPageLoadingMsg() }, complete: function () { $.mobile.hidePageLoadingMsg() }, type: "POST", url: wsURL + "appStart", cache: false, data: '{"u":"' + top.pinUser + '","p":"' + top.pinPswd + '","d":"' + dtNow + '"}', contentType: "application/json; charset=utf-8", success: function (e) { if (e.d == "e") { alert("MapitPRO ERROR: Username or password is not valid... Try again!") } else { var t = jQuery.parseJSON(e.d); var n = t.NewDataSet.Table; if (n.PIN_ACTIVE == "true") { $("#btnStart").closest(".ui-btn").hide(); $("#btnStop").closest(".ui-btn").show(); appInterval() } else { $("#btnStart").closest(".ui-btn").show(); $("#btnStop").closest(".ui-btn").hide(); $("#geoLoc").html("") } } }, error: function (e) { technicalError() } }) } else { internetError() } return false } function appUpdate() { if (navigator.onLine) { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(function (e) { var t = e.coords.latitude; var n = e.coords.longitude; getLongDT(); $.ajax({ beforeSend: function () { $.mobile.showPageLoadingMsg() }, complete: function () { $.mobile.hidePageLoadingMsg() }, type: "POST", url: wsURL + "appUpdate", cache: false, data: '{"u":"' + top.pinUser + '","p":"' + top.pinPswd + '","t":"' + t + '","g":"' + n + '","d":"' + dtNow + '"}', contentType: "application/json; charset=utf-8", success: function (e) { if (e.d == "s") { $("#geoLoc").html("<br />Lat: " + t + " Lng: " + n).trigger("create") } else { alert("MapitPRO ERROR: Unable to update location... Quit application and try again!") } }, error: function (e) { technicalError() } }) }) } else { alert("MapitPRO ERROR: You must enable your GPS/Geolocation on your device to use this application!") } } else { internetError() } return false } function appStop() { if (navigator.onLine) { getLongDT(); $.ajax({ beforeSend: function () { $.mobile.showPageLoadingMsg() }, complete: function () { $.mobile.hidePageLoadingMsg() }, type: "POST", url: wsURL + "appStop", cache: false, data: '{"u":"' + top.pinUser + '","p":"' + top.pinPswd + '","d":"' + dtNow + '"}', contentType: "application/json; charset=utf-8", success: function (e) { if (e.d == "e") { alert("MapitPRO ERROR: Unable to stop application... Quit application and try again!") } else { $("#btnStart").closest(".ui-btn").show(); $("#btnStop").closest(".ui-btn").hide(); $("#geoLoc").html(""); clearInterval(top.updateId); top.updateId = ""; top.pinActive = false; var t = jQuery.parseJSON(e.d); var n = t.NewDataSet.Table; if (n[1].SETTINGS_SYNCTIME != null) { top.syncTime = parseInt(n[1].SETTINGS_SYNCTIME) } } }, error: function (e) { technicalError() } }) } else { internetError() } return false } function appLogout() { if (navigator.onLine) { getLongDT(); $.ajax({ beforeSend: function () { $.mobile.showPageLoadingMsg() }, complete: function () { $.mobile.hidePageLoadingMsg() }, type: "POST", url: wsURL + "appStop", cache: false, data: '{"u":"' + top.pinUser + '","p":"' + top.pinPswd + '","d":"' + dtNow + '"}', contentType: "application/json; charset=utf-8", success: function (e) { if (e.d != "e") { $("#inpUsername").textinput("enable"); $("#inpPassword").textinput("enable"); $("#btnLogin").closest(".ui-btn").show(); $("#btnLogout").closest(".ui-btn").hide(); $("#btnStart").closest(".ui-btn").hide(); $("#btnStop").closest(".ui-btn").hide(); $("#geoLoc").html(""); clearInterval(top.updateId); top.updateId = ""; top.pinActive = false } else { alert("MapitPRO ERROR: Unable to logout from application... Quit application manually!") } }, error: function (e) { technicalError() } }) } else { internetError() } return false } function disableF5(e) { if (e.which == 116 || e.which == 8) { e.preventDefault() } } top.updateId = ""; top.syncTime = 60; top.pinUser = ""; top.pinPswd = ""; top.pinActive = ""; var wsURL = "../mipservice.asmx/"; $("#btnLogin").live("click", function () { top.pinUser = $("#inpUsername").val(); top.pinPswd = $("#inpPassword").val(); appLogin() }); $("#btnLogout").live("click", function () { appLogout(); top.syncTime = 60; top.pinUser = ""; top.pinPswd = "" }); $("#btnStart").live("click", function () { $("#btnStart").closest(".ui-btn").hide(); $("#btnStop").closest(".ui-btn").show(); appUpdate(); appInterval() }); $("#btnStop").live("click", function () { appStop() }); $(document).bind("keydown", disableF5); $(document).bind("contextmenu", function (e) { e.preventDefault() }); window.history.pushState(null, null, "../index.html")